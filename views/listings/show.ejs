<% layout("/layout/boilerplate.ejs") %>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8 text-center">
      <h1 class="display-5 fw-bold"><%= listings.title %></h1>
      <img src="<%= listings.image.url %>" class="img-fluid rounded shadow my-4"
       alt="listing_image">
    </div>
</div>

<div class="row justify-content-center">
   <div class="col-md-8">
    <div class="card shadow-lg border-0 rounded-3 mb-4">
      <div class="card-body p-4">
        <h3 class="fw-bold mb-4 text-center">Listing Details</h3>
        
        <p> <i> Owned by <%= listings.owner.username %></i> </p>

        <div class="mb-3 d-flex align-items-center">
          <i class="bi bi-tag-fill text-primary me-2 fs-5"></i>
          <span><strong>Title:</strong> <%= listings.title %></span>
        </div>

        <div class="mb-3 d-flex align-items-start">
          <i class="bi bi-file-text-fill text-secondary me-2 fs-5"></i>
          <span><strong>Description:</strong> <%= listings.description %></span>
        </div>

        <div class="mb-3 d-flex align-items-center">
          <i class="bi bi-currency-rupee text-success me-2 fs-5"></i>
          <span><strong>Price:</strong> â‚¹<%= listings.price.toLocaleString("en-IN") %></span>
        </div>

        <div class="mb-3 d-flex align-items-center">
          <i class="bi bi-geo-alt-fill text-danger me-2 fs-5"></i>
          <span><strong>Location:</strong> <%= listings.location %>, <%= listings.country %></span>
        </div>
        
        <% if(currentUser && String(currentUser._id) === String(listings.owner._id)) { %>
       <div class="d-flex gap-2 mb-3">
       <a href="/listings/<%= listings._id %>/edit" class="btn btn-outline-primary btn-sm">Edit</a>
       <form method="POST" action="/listings/<%= listings._id %>?_method=DELETE">
      <button class="btn btn-outline-danger btn-sm ownerbutton">Delete</button>
      </form>
       </div>
      <% } %>

      </div>
    </div>
  </div>
</div>

  <hr>

<% if(currentUser) {%>
<!-- Leave a Review Section -->
<div class="row justify-content-center review" style="margin-bottom:0;">
  <div class="col-md-8">
  <div class="card shadow-lg border-0 rounded-3 mb-2">
      <div class="card-body p-4">
        <h2 class="mb-4 text-center fw-bold">Leave a Review</h2>
        <form action="/listings/<%= listings._id %>/reviews" method="POST" class="needs-validation" novalidate>
          
          <!-- Rating (Star System) -->
          <fieldset class="starability-slot mb-4">
            <legend>Rating:</legend>
            <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />
            <input type="radio" id="first-rate1" name="review[rating]" value="1" />
            <label for="first-rate1" title="Terrible">1 star</label>
            <input type="radio" id="first-rate2" name="review[rating]" value="2" />
            <label for="first-rate2" title="Not good">2 stars</label>
            <input type="radio" id="first-rate3" name="review[rating]" value="3" />
            <label for="first-rate3" title="Average">3 stars</label>
            <input type="radio" id="first-rate4" name="review[rating]" value="4" />
            <label for="first-rate4" title="Very good">4 stars</label>
            <input type="radio" id="first-rate5" name="review[rating]" value="5" />
            <label for="first-rate5" title="Amazing">5 stars</label>
          </fieldset>


          <!-- Comment -->
          <div class="mb-4">
            <label for="comment" class="form-label fw-semibold">Comment</label>
            <textarea name="review[comment]" id="comment" rows="4" class="form-control shadow-sm" placeholder="Write your experience..." required></textarea>
            <div class="invalid-feedback">Please write a comment.</div>
          </div>

          <!-- Submit -->
          <div class="text-center">
            <button class="btn btn-dark px-5 rounded-pill">Submit Review</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<% } %>

<% if (listings.reviews.length > 0) { %>
  <div class="container my-4">
    <h2 class="mb-4">All Reviews</h2>
    <div class="row row-cols-1 row-cols-md-2 g-4">
      <% for (let review of listings.reviews) { %>
        <div class="col">
          <div class="card shadow-sm h-100">
            <div class="card-body">
               <p class="starability-result card-title" data-rating="<%= review.rating %>"></p>
              <p class="card-text"><%= review.comment %></p>
            </div>
           <div class="card-footer d-flex justify-content-between align-items-center text-muted">
              <span>Reviewed by <%= review.author.username || "Anonymous" %></span>
              <form method="POST" 
              action="/listings/<%= listings._id %>/reviews/<%= review._id %>?_method=DELETE" 
              style="display:inline;">
             <button class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this review?');">Delete</button>
             </form>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </div>
<% } %>
<br>
<br>

<!-- Map Section -->
<div class="container my-3 mapimage">
  <strong id="mapheading">You will be here:</strong>
  <br>
  <br>
  <div class="map-container rounded shadow-sm " style="max-width: 400px; margin: 0 auto;">
    <iframe
      src="https://www.google.com/maps?q=<%= encodeURIComponent(listings.location + ', ' + listings.country) %>&output=embed"
      width="100%"
      height="450"
      style="border:0;"
      allowfullscreen=""
      loading="lazy"
      referrerpolicy="no-referrer-when-downgrade">
    </iframe>
  </div>
  <div class="mt-2 text-center">
    <a href="<%= listings.mapUrl %>" target="_blank" rel="noopener" class="btn btn-outline-info btn-sm">
      View on Google Maps
    </a>
  </div>
</div>

